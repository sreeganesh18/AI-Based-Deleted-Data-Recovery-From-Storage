---
phase: 03-carving-denoising
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [utils/training.py, utils/validation.py, scripts/train_classifier.py, scripts/train_autoencoder.py]
autonomous: true
requirements: [PH3-01, PH3-02, PH3-03]
must_haves:
  truths:
    - "Training scripts use a separate 20% validation set."
    - "Classifier training logs accuracy and loss every epoch."
    - "Autoencoder training logs PSNR and SSIM metrics."
    - "Classifier reaches 90% accuracy for JPEG and 85% for PDF fragments."
  artifacts:
    - path: "utils/training.py"
      provides: "Trainer class with advanced metrics support"
    - path: "scripts/train_classifier.py"
      provides: "Updated classification training with 80/20 split"
    - path: "scripts/train_autoencoder.py"
      provides: "Updated autoencoder training with 80/20 split and PSNR/SSIM"
  key_links:
    - from: "scripts/train_autoencoder.py"
      to: "utils/validation.py"
      via: "PSNR/SSIM calculation"
---

<objective>
Update training infrastructure to support robust evaluation and meet accuracy/quality targets for the Classifier and Autoencoder models.
Purpose: Ensure models are reliable and meet performance thresholds specified in the project context.
Output: Updated training/validation utilities, trained model checkpoints, and evaluation logs.
</objective>

<execution_context>
@C:/Users/devid/.gemini/get-shit-done/workflows/execute-plan.md
@C:/Users/devid/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-CONTEXT.md
@utils/training.py
@utils/validation.py
@scripts/train_classifier.py
@scripts/train_autoencoder.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Validation Utilities with PSNR and SSIM</name>
  <files>utils/validation.py, utils/training.py</files>
  <action>
    - Add `calculate_psnr` and `calculate_ssim` functions to `utils/validation.py`. Use `torch` or `skimage` (if available, else implement basic PSNR in torch).
    - Update `utils/training.py`:
      - Modify `Trainer.validate_epoch` to support task-specific metrics (accuracy for classification, PSNR/SSIM for autoencoders).
      - Ensure history logs all relevant metrics every epoch.
  </action>
  <verify>
    <automated>pytest tests/test_validation.py tests/test_autoencoder.py</automated>
  </verify>
  <done>Validation utilities support accuracy, loss, PSNR, and SSIM metrics.</done>
</task>

<task type="auto">
  <name>Task 2: Implement 80/20 Validation Split in Training Scripts</name>
  <files>scripts/train_classifier.py, scripts/train_autoencoder.py</files>
  <action>
    - Update both training scripts to use `torch.utils.data.random_split` to create a 80% training and 20% validation set from the `FragmentDataset`.
    - Ensure validation data is NOT used for training.
    - Implement logging of metrics to console and optionally to a log file after each epoch as per 03-CONTEXT.md.
  </action>
  <verify>
    <automated>python scripts/train_classifier.py --epochs 1 --batch_size 4</automated>
  </verify>
  <done>Training scripts use 80/20 split and log metrics every epoch.</done>
</task>

<task type="auto">
  <name>Task 3: Train and Evaluate Models to Targets</name>
  <files>models/checkpoints/classifier_best.pth, models/checkpoints/autoencoder_best.pth</files>
  <action>
    - Execute `scripts/train_classifier.py` and `scripts/train_autoencoder.py` with sufficient epochs to meet targets.
    - Target: Classifier (90% JPEG, 85% PDF).
    - Autoencoder: Log PSNR/SSIM for the best model.
    - Save 'best' checkpoints based on validation performance.
  </action>
  <verify>
    <automated>python scripts/train_classifier.py --evaluate --checkpoint models/checkpoints/classifier_best.pth</automated>
  </verify>
  <done>Models trained and checkpoints saved; Classifier meets accuracy targets.</done>
</task>

</tasks>

<verification>
Check training logs for accuracy and quality targets.
Verify checkpoints are created in `models/checkpoints/`.
</verification>

<success_criteria>
- Classifier accuracy >= 90% for JPEG fragments.
- Classifier accuracy >= 85% for PDF fragments.
- PSNR and SSIM metrics are recorded for Autoencoder performance.
- Validation sets are distinct and 20% of total data.
</success_criteria>

<output>
After completion, create `.planning/phases/03-carving-denoising/03-01-SUMMARY.md`
</output>
