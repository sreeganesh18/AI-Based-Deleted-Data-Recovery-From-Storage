---
phase: 04-reconstruction-enhancement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [reconstruction/grouping.py, tests/test_grouping.py]
autonomous: true
requirements: [RECON-01, RECON-02]
must_haves:
  truths:
    - "FragmentGrouper uses a 1MB search radius (approx 100 clusters)."
    - "Reconstruction logic prioritizes sequential disk offsets and AI sequence scoring (mixed approach)."
    - "Missing data gaps are filled with zeros to maintain structural alignment."
    - "Parallel reconstruction is attempted if a new header is found mid-file."
  artifacts:
    - path: "reconstruction/grouping.py"
      provides: "FragmentGrouper class with mixed-approach reassembly"
  key_links:
    - from: "reconstruction/grouping.py"
      to: "04-CONTEXT.md"
      via: "1MB search radius constraint"
---

<objective>
Implement the core fragment grouping and reassembly logic, focusing on non-contiguous files and parallel reconstruction.
Purpose: Ensure that fragmented disk data can be reassembled into coherent file streams, handling gaps and overlapping headers as per project context.
Output: Updated FragmentGrouper with mixed-approach logic and parallel reconstruction support.
</objective>

<execution_context>
@C:/Users/devid/.gemini/get-shit-done/workflows/execute-plan.md
@C:/Users/devid/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-CONTEXT.md
@reconstruction/grouping.py
@carving/hybrid.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Re-implement FragmentGrouper with Mixed Approach</name>
  <files>reconstruction/grouping.py</files>
  <action>
    - Update `FragmentGrouper` to handle 512-byte fragments with their original disk offsets.
    - Implement a 1MB (1,048,576 bytes) search radius for finding the next block.
    - Implement the "mixed" ordering logic:
      - Prioritize sequential clusters (next offset == current offset + block_size).
      - Use AI sequence scoring (simulated or via a dedicated model) as a fallback/reinforcement.
    - Implement "best effort" reconstruction until the end of the image if no footer is found.
    - Ensure all missing gaps are filled with `b"\x00"` to maintain the file's structural integrity.
  </action>
  <verify>
    <automated>pytest tests/test_grouping.py</automated>
  </verify>
  <done>FragmentGrouper reassembles fragments using a mixed approach with a 1MB search radius and zero-filling for gaps.</done>
</task>

<task type="auto">
  <name>Task 2: Implement Parallel Reconstruction Logic</name>
  <files>reconstruction/grouping.py</files>
  <action>
    - Extend `FragmentGrouper` to support branching when a new header is found mid-reconstruction.
    - Ensure that both the original file path and the new file path are tracked independently.
    - Implement conflict resolution logic for fragments that could belong to multiple active reconstruction paths (best-effort prioritization).
  </action>
  <verify>
    <automated>python tests/test_grouping.py --parallel</automated>
  </verify>
  <done>Grouping logic handles overlapping file headers by branching into parallel reconstruction paths.</done>
</task>

</tasks>

<verification>
Check reassembly accuracy on fragmented dummy data.
Verify that gaps in non-contiguous files are correctly zero-filled.
Confirm that parallel paths are created when multiple headers are encountered.
</verification>

<success_criteria>
- Fragment search respects the 1MB radius.
- Reassembled files maintain structural alignment via zero-filling.
- Parallel reconstruction paths are correctly managed for overlapping headers.
- Sequential offsets are prioritized where appropriate.
</success_criteria>

<output>
After completion, create `.planning/phases/04-reconstruction-enhancement/04-01-SUMMARY.md`
</output>
