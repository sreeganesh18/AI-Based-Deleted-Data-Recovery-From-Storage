---
phase: 04-reconstruction-enhancement
plan: 02
type: execute
wave: 2
depends_on: [04-01-PLAN.md]
files_modified: [reconstruction/repair.py, tests/test_repair.py]
autonomous: true
requirements: [RECON-03]
must_haves:
  truths:
    - "JPEG structural repair synthesizes missing headers/footers where possible."
    - "PDF repair uses PyMuPDF or Ghostscript to rebuild XREF tables."
    - "Integrity checks are performed on all recovered files with headers."
  artifacts:
    - path: "reconstruction/repair.py"
      provides: "Structural repair module for JPEGs and PDFs"
---

<objective>
Implement structural repair mechanisms for JPEG and PDF files to ensure reassembled fragments form valid file structures.
Purpose: Fix broken file markers and internal references (XREF) common in fragmented data recovery.
Output: Functional structural repair module for common forensic file types.
</objective>

<execution_context>
@C:/Users/devid/.gemini/get-shit-done/workflows/execute-plan.md
@C:/Users/devid/.gemini/get-shit-done/templates/summary.md
</execution_context>

<tasks>

<task type="auto">
  <name>Task 1: Implement JPEG Structural Repair</name>
  <files>reconstruction/repair.py</files>
  <action>
    - Create `reconstruction/repair.py`.
    - Implement `repair_jpeg` function:
      - Synthesize missing SOI/APP0 markers if needed.
      - Ensure EOI marker is present if reconstruction stopped before finding a footer.
      - Implement basic marker consistency checks.
  </action>
  <verify>
    <automated>python reconstruction/repair.py --test-jpeg</automated>
  </verify>
  <done>JPEG files can have their headers and markers synthesized/repaired.</done>
</task>

<task type="auto">
  <name>Task 2: Implement PDF XREF Repair</name>
  <files>reconstruction/repair.py</files>
  <action>
    - Add `repair_pdf` function to `reconstruction/repair.py`.
    - Integrate `PyMuPDF` (fitz) to attempt `save(..., clean=True, incremental=False)` or similar logic to rebuild XREF tables.
    - Fallback to Ghostscript via subprocess if PyMuPDF fails to fix a deeply corrupted file.
  </action>
  <verify>
    <automated>python reconstruction/repair.py --test-pdf</automated>
  </verify>
  <done>Broken PDF files are repaired by rebuilding their internal cross-reference tables.</done>
</task>

<task type="auto">
  <name>Task 3: Implement Integrity Validation Utility</name>
  <files>reconstruction/repair.py, utils/validation.py</files>
  <action>
    - Add a unified `validate_integrity` function that uses `PIL` for images and `PyMuPDF` for PDFs to check if the file is openable.
    - Log failures but do not delete files, as per 04-CONTEXT.md.
  </action>
  <verify>
    <automated>pytest tests/test_repair.py</automated>
  </verify>
  <done>Integrated integrity checks confirm if repaired files are usable.</done>
</task>

</tasks>

<output>
After completion, create `.planning/phases/04-reconstruction-enhancement/04-02-SUMMARY.md`
</output>
